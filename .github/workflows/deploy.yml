name: Deploy to Digital Ocean

on:
    push:
        branches:
            - main
    workflow_dispatch: # Allow manual trigger

env:
    REGISTRY: registry.digitalocean.com
    REGISTRY_NAME: pulsepoint-registry
    IMAGE_NAME: pulsepoint-api
    APP_NAME: pulsepoint-medical-ai

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                  token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to DigitalOcean Container Registry
              run: doctl registry login

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  platforms: linux/amd64
                  push: true
                  tags: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest
                  cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:buildcache
                  cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

            - name: Get image digest
              id: get_digest
              run: |
                  # Wait for registry to update
                  sleep 5

                  # Get the digest of the latest tag
                  DIGEST=$(doctl registry repository list-tags ${{ env.IMAGE_NAME }} --format Tag,Digest | grep "latest" | awk '{print $NF}')

                  if [ -z "$DIGEST" ] || [ "$DIGEST" == "0" ]; then
                    echo "âŒ Could not get image digest"
                    exit 1
                  fi

                  echo "digest=$DIGEST" >> $GITHUB_OUTPUT
                  echo "âœ… Image digest: $DIGEST"

            - name: Update app-spec.template.yaml with digest
              run: |
                  # Replace tag with digest in app-spec.template.yaml
                  sed -i "s|tag: latest|digest: ${{ steps.get_digest.outputs.digest }}|g" app-spec.template.yaml

                  echo "âœ… Updated app-spec.template.yaml:"
                  grep -A2 "image:" app-spec.template.yaml | head -5

            - name: Deploy to Digital Ocean App Platform
              run: |
                  # Get app ID
                  APP_ID=$(doctl apps list --format ID,Spec.Name | grep "${{ env.APP_NAME }}" | awk '{print $1}')

                  if [ -z "$APP_ID" ]; then
                    echo "ðŸ“¦ Creating new app: ${{ env.APP_NAME }}"
                    doctl apps create --spec app-spec.template.yaml
                    echo "âœ… App created successfully!"
                  else
                    echo "ðŸ”„ Updating existing app: ${{ env.APP_NAME }} (ID: $APP_ID)"
                    doctl apps update $APP_ID --spec app-spec.template.yaml
                    echo "âœ… App updated successfully!"
                  fi

            - name: Get deployment status
              run: |
                  APP_ID=$(doctl apps list --format ID,Spec.Name | grep "${{ env.APP_NAME }}" | awk '{print $1}')

                  echo "ðŸ“Š Deployment Status:"
                  doctl apps get $APP_ID --format ID,DefaultIngress,ActiveDeployment.Phase,UpdatedAt

                  echo ""
                  echo "ðŸŒ App URL: https://$(doctl apps get $APP_ID --format DefaultIngress --no-header)"

            - name: Deployment summary
              run: |
                  echo "## ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **App:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Image:** ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/${{ env.IMAGE_NAME }}@${{ steps.get_digest.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
                  echo "- [View App in Digital Ocean](https://cloud.digitalocean.com/apps)" >> $GITHUB_STEP_SUMMARY
                  echo "- [View Container Registry](https://cloud.digitalocean.com/registry)" >> $GITHUB_STEP_SUMMARY
